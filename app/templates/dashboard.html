{% extends "base.html" %}

{% block content %}
<div class="workbench-container">
    
    <aside class="workbench-sidebar">
        <div class="sidebar-header">
            <h2><i data-feather="settings"></i> Configuration</h2>
        </div>

        <div class="config-group">
            <label class="form-label">Location Name</label>
            <input type="text" id="location-input" class="form-input" placeholder="e.g. R&R Skudai" value="{{ session.get('location', 'Unknown') }}">
        </div>

        <div class="config-group">
            <label class="form-label">Session Date/Time</label>
            <input type="datetime-local" id="session-time" class="form-input">
            <small class="text-secondary">Establishes the timeline anchor.</small>
        </div>

        <hr class="sidebar-divider">

        <label class="form-label">Select Camera to Configure</label>
        <div class="camera-tabs">
            <button class="tab-btn active" onclick="switchCameraContext('ENTRY')" id="tab-entry">
                <i data-feather="log-in"></i> Entry Cam
            </button>
            <button class="tab-btn" onclick="switchCameraContext('EXIT')" id="tab-exit">
                <i data-feather="log-out"></i> Exit Cam
            </button>
        </div>

        <div class="source-config-card">
            <div class="status-indicator">
                <span class="status-dot" id="config-status-dot"></span>
                <span id="config-status-text">Not Configured</span>
            </div>

            <div class="config-group mt-2">
                <label class="form-label">Video Source</label>
                <input type="file" id="video-upload" accept="video/*" class="form-input" style="display: none;">
                <button class="btn btn-outline btn-full" onclick="document.getElementById('video-upload').click()">
                    <i data-feather="upload"></i> Upload Video File
                </button>
                <div id="file-name-display" class="file-name text-truncate mt-1">No file selected</div>
            </div>

            <div class="config-group">
                <label class="form-label">Instructions</label>
                <ul class="instruction-list">
                    <li>1. Upload a video.</li>
                    <li>2. Draw the crossing line on the canvas.</li>
                    <li>3. Repeat for other camera.</li>
                </ul>
                <button class="btn btn-sm btn-secondary mt-2" id="clear-line-btn" disabled>
                    <i data-feather="refresh-cw"></i> Redraw Line
                </button>
            </div>
        </div>

        <div class="sidebar-footer">
            <button id="btn-start-analysis" class="btn btn-primary btn-full btn-lg" disabled>
                <i data-feather="play"></i> Start Analysis
            </button>
            <div id="processing-status" class="hidden mt-2">
                <div class="dual-progress">
                    <div class="progress-item">
                        <span class="progress-label">Entry: <span id="entry-progress-text">0%</span></span>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="entry-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <span class="progress-label">Exit: <span id="exit-progress-text">0%</span></span>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="exit-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <main class="workbench-main">
        
        <section class="video-stage-panel">
            <div class="stage-header">
                <div class="stage-title">
                    <span class="badge badge-processing hidden" id="live-badge">LIVE ANALYSIS</span>
                    <h3>Camera Preview</h3>
                </div>
                <div class="stage-controls">
                    <span class="text-secondary" style="font-size: 0.9rem;">Mode: <span id="mode-label">Setup</span></span>
                </div>
            </div>

            <div class="dual-camera-grid">
                <!-- Entry Camera -->
                <div class="camera-preview-card" id="entry-camera-card">
                    <div class="camera-header">
                        <span class="badge badge-entry"><i data-feather="log-in"></i> ENTRY</span>
                        <span class="camera-status" id="entry-camera-status">Not Configured</span>
                    </div>
                    <div class="video-wrapper" id="entry-video-container">
                        <canvas id="entry-canvas"></canvas>
                        <img id="entry-live-feed" src="" class="hidden" alt="Entry Feed">
                        <div id="entry-placeholder" class="stage-placeholder">
                            <i data-feather="video" style="width: 36px; height: 36px; opacity: 0.5;"></i>
                            <p>Upload Entry Camera Video</p>
                        </div>
                    </div>
                </div>

                <!-- Exit Camera -->
                <div class="camera-preview-card" id="exit-camera-card">
                    <div class="camera-header">
                        <span class="badge badge-exit"><i data-feather="log-out"></i> EXIT</span>
                        <span class="camera-status" id="exit-camera-status">Not Configured</span>
                    </div>
                    <div class="video-wrapper" id="exit-video-container">
                        <canvas id="exit-canvas"></canvas>
                        <img id="exit-live-feed" src="" class="hidden" alt="Exit Feed">
                        <div id="exit-placeholder" class="stage-placeholder">
                            <i data-feather="video" style="width: 36px; height: 36px; opacity: 0.5;"></i>
                            <p>Upload Exit Camera Video</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="analytics-panel">
            <h3 class="panel-title">Session Analytics</h3>
            
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon green"><i data-feather="arrow-down-circle"></i></div>
                    <div class="kpi-content">
                        <div class="kpi-label">Vehicles In</div>
                        <div class="kpi-value positive" id="vehicles-in">0</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon red"><i data-feather="arrow-up-circle"></i></div>
                    <div class="kpi-content">
                        <div class="kpi-label">Vehicles Out</div>
                        <div class="kpi-value negative" id="vehicles-out">0</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon blue"><i data-feather="truck"></i></div>
                    <div class="kpi-content">
                        <div class="kpi-label">Net Vehicles</div>
                        <div class="kpi-value" id="net-vehicles">0</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon orange"><i data-feather="users"></i></div>
                    <div class="kpi-content">
                        <div class="kpi-label">Est. People Range</div>
                        <div class="kpi-value" id="people-range">0 - 0</div>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i data-feather="bar-chart-2"></i> Net Vehicles by Type</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i data-feather="list"></i> Realtime Log</div>
                        <span class="badge badge-processing" id="event-count">0 events</span>
                    </div>
                    <div class="event-log-container">
                        <table class="event-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Type</th>
                                    <th>Direction</th>
                                    <th>Seats (Min - Max)</th>
                                </tr>
                            </thead>
                            <tbody id="event-log-body">
                                <tr class="empty-row">
                                    <td colspan="4" class="text-center text-secondary">No events yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Session Choice Modal -->
<div id="session-choice-modal" class="modal hidden">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3><i data-feather="help-circle"></i> New Analysis</h3>
        </div>
        <div class="modal-body">
            <p>You have existing analysis data from a previous session. What would you like to do?</p>
        </div>
        <div class="modal-actions">
            <button id="btn-continue-session" class="btn btn-primary">
                <i data-feather="plus-circle"></i> Continue Session
                <small>Add to existing totals</small>
            </button>
            <button id="btn-new-session" class="btn btn-outline">
                <i data-feather="refresh-cw"></i> Start Fresh
                <small>Reset all counts</small>
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script src="https://unpkg.com/feather-icons"></script>

<script src="{{ url_for('static', filename='js/setup_canvas.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<script>
    // Quick initialize for icons
    feather.replace();
    
    // Set default datetime to now
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    const sessionTimeInput = document.getElementById('session-time');
    if (sessionTimeInput) {
        sessionTimeInput.value = now.toISOString().slice(0,16);
    }
</script>
{% endblock %}