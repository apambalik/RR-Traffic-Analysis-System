{% extends "base.html" %}

{% block title %}Configuration - R&R Vehicle Analytics{% endblock %}

{% block content %}
<div class="setup-layout">
    <!-- Left Sidebar -->
    <aside class="setup-sidebar">
        <a href="{{ url_for('dashboard.index') }}" class="back-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back
        </a>

        <!-- Input Source Section -->
        <div class="sidebar-section">
            <h3 class="sidebar-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                Input Source
            </h3>

            <div class="form-group">
                <label class="form-label">Camera Role</label>
                <select class="form-select" id="camera-role">
                    <option value="ENTRY">Entry Camera</option>
                    <option value="EXIT">Exit Camera</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Select Source Type</label>
                <select class="form-select" id="source-type">
                    <option value="">Select</option>
                    <option value="video">Video File</option>
                    <option value="camera">Live Camera</option>
                </select>
            </div>

            <div id="video-upload-section">
                <input type="file" id="video-input" accept="video/*" class="hidden">
                <button class="btn btn-primary btn-full" id="browse-btn">
                    Browse Files
                </button>
                <div id="file-name" class="file-name-display"></div>
            </div>

            <div id="camera-section" class="hidden">
                <div class="form-group">
                    <label class="form-label">Camera URL</label>
                    <input type="text" class="form-input" id="camera-url" placeholder="rtsp://...">
                </div>
            </div>
        </div>

        <!-- Location Section -->
        <div class="sidebar-section">
            <div class="form-group">
                <label class="form-label">R&R Location</label>
                <input type="text" class="form-input" id="location-input" placeholder="e.g., Skudai">
            </div>
        </div>

        <!-- Action Panel -->
        <div class="sidebar-section">
            <h3 class="sidebar-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 3v18M3 12h18"/>
                </svg>
                Action Panel
            </h3>

            <!-- <button class="btn btn-primary btn-full" id="set-line-btn" disabled>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                </svg>
                Set Counting Line
            </button> -->

            <button class="btn btn-outline btn-full" id="reset-line-btn" disabled>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
                Reset Line
            </button>

            <hr class="sidebar-divider">

            <button class="btn btn-success btn-full" id="save-config-btn" disabled>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17,21 17,13 7,13 7,21"/>
                    <polyline points="7,3 7,8 15,8"/>
                </svg>
                Start Processing
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="setup-main">
        <!-- Instruction Alert -->
        <div class="alert alert-warning">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            <div>
                <strong>Instruction:</strong> 
                Drag the endpoints of the line to define the entry/exit threshold. 
                The line should be placed perpendicular to vehicle traffic flow.
            </div>
        </div>

        <!-- Video Preview -->
        <div class="preview-section">
            <h3 class="preview-title">Video Preview</h3>
            
            <div class="canvas-wrapper">
                <div class="canvas-container" id="canvas-container">
                    <canvas id="preview-canvas"></canvas>
                    <div class="canvas-placeholder" id="canvas-placeholder">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        <p>Video Feed Preview</p>
                        <span class="canvas-info" id="frame-info">Frame: 1/1200 | Time: 00:00:00</span>
                    </div>
                </div>
            </div>

            <div class="line-position">
                <span>Line Position:</span>
                <span class="position-value" id="line-position">X: --, Y: --</span>
            </div>
        </div>

        <!-- Processing Progress (hidden by default) -->
        <div class="processing-section hidden" id="processing-section">
            <h3>Processing Video...</h3>
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
            </div>
            <p class="progress-text" id="progress-text">0% complete</p>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/setup_canvas.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sourceType = document.getElementById('source-type');
    const videoInput = document.getElementById('video-input');
    const browseBtn = document.getElementById('browse-btn');
    const fileNameDisplay = document.getElementById('file-name');
    const videoUploadSection = document.getElementById('video-upload-section');
    const cameraSection = document.getElementById('camera-section');
    // const setLineBtn = document.getElementById('set-line-btn');
    const resetLineBtn = document.getElementById('reset-line-btn');
    const saveConfigBtn = document.getElementById('save-config-btn');
    const canvasPlaceholder = document.getElementById('canvas-placeholder');
    const linePosition = document.getElementById('line-position');
    const processingSection = document.getElementById('processing-section');
    
    let lineDrawer = null;
    let lineSet = false;

    // Source type change
    sourceType.addEventListener('change', function() {
        if (this.value === 'video') {
            videoUploadSection.classList.remove('hidden');
            cameraSection.classList.add('hidden');
        } else if (this.value === 'camera') {
            videoUploadSection.classList.add('hidden');
            cameraSection.classList.remove('hidden');
        }
    });

    // Browse button click
    browseBtn.addEventListener('click', function() {
        videoInput.click();
    });

    // Video file selected
    videoInput.addEventListener('change', async function() {
        if (this.files.length > 0) {
            const file = this.files[0];
            fileNameDisplay.textContent = file.name;
            
            // Upload video
            const formData = new FormData();
            formData.append('video', file);
            
            try {
                const response = await fetch('/setup/upload-video', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Get first frame
                    await loadFirstFrame();
                    // setLineBtn.disabled = false;
                } else {
                    alert('Error uploading video: ' + data.error);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload video');
            }
        }
    });

    async function loadFirstFrame() {
        try {
            const response = await fetch('/setup/get-first-frame');
            const data = await response.json();
            
            if (data.frame) {
                // Hide placeholder first
                canvasPlaceholder.style.display = 'none';
                canvasPlaceholder.classList.add('hidden');
                
                // Initialize line drawer
                lineDrawer = new LineDrawer('preview-canvas');
                await lineDrawer.loadImage('data:image/jpeg;base64,' + data.frame);
                
                // Update instruction
                console.log('Frame loaded, canvas ready for drawing');
                
                // Line complete callback
                lineDrawer.onLineComplete = function(points) {
                    lineSet = true;
                    resetLineBtn.disabled = false;
                    saveConfigBtn.disabled = false;
                    
                    const startX = Math.round(points[0][0]);
                    const startY = Math.round(points[0][1]);
                    const endX = Math.round(points[1][0]);
                    const endY = Math.round(points[1][1]);
                    
                    linePosition.textContent = `Start: (${startX}, ${startY}) â†’ End: (${endX}, ${endY})`;
                };
            } else {
                console.error('No frame data received');
                alert('Failed to load video frame');
            }
        } catch (error) {
            console.error('Error loading frame:', error);
            alert('Error loading video frame: ' + error.message);
        }
    }

    // Set counting line button - just provides instruction
    // setLineBtn.addEventListener('click', function() {
    //     if (lineDrawer) {
    //         alert('Click and drag on the video preview to draw the counting line');
    //     } else {
    //         alert('Please upload a video first');
    //     }
    // });

    // Reset line button
    resetLineBtn.addEventListener('click', function() {
        if (lineDrawer) {
            lineDrawer.reset();
            lineSet = false;
            saveConfigBtn.disabled = true;
            linePosition.textContent = 'X: --, Y: --';
        }
    });

    // Save configuration / Start processing
    saveConfigBtn.addEventListener('click', async function() {
        if (!lineDrawer || !lineSet) {
            alert('Please draw a counting line first');
            return;
        }
        
        const linePoints = lineDrawer.getLinePoints();
        const location = document.getElementById('location-input').value || 'Unknown';
        const cameraRole = document.getElementById('camera-role').value;
        
        try {
            // Save line coordinates
            await fetch('/setup/save-line', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ line_points: linePoints })
            });
            
            // Show processing section
            processingSection.classList.remove('hidden');
            saveConfigBtn.disabled = true;
            
            // Start processing
            const response = await fetch('/setup/start-processing', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    location: location,
                    camera_role: cameraRole 
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Redirect to dashboard
                window.location.href = '/';
            } else {
                alert('Processing error: ' + data.error);
                processingSection.classList.add('hidden');
                saveConfigBtn.disabled = false;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to start processing');
            processingSection.classList.add('hidden');
            saveConfigBtn.disabled = false;
        }
    });
});
</script>
{% endblock %}
